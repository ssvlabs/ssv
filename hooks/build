#!/bin/bash
set -eo pipefail

# Enable Docker BuildKit
export DOCKER_BUILDKIT=1

# Platform(s) to build for
PLATFORMS="linux/amd64,linux/arm64"

# Extract the Git tag from the SOURCE_COMMIT
APP_VERSION=$(git describe --tags "${SOURCE_COMMIT}")

echo "Building image version ${APP_VERSION} for platforms: ${PLATFORMS}"

# Create and configure buildx builder
docker buildx rm ssv-multiplatform-builder  2>/dev/null || true
docker buildx create --name ssv-multiplatform-builder --driver docker-container --bootstrap --use

# Build and push for multiple architectures
docker buildx build \
    --platform "${PLATFORMS}" \
    --build-arg APP_VERSION="${APP_VERSION}" \
    -t "${IMAGE_NAME}" \
    --push \
    .

echo "Build and push completed successfully!"
